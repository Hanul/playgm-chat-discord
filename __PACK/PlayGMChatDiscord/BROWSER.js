global.EMOTICONS=["와샌즈","와파피루스","기모띠","ppap"],PlayGMChatDiscord.MAIN=METHOD({run:()=>{const e=/(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-a-z\u0080-\uffff\d{1-3}]+\.)+(?:[a-z\u0080-\uffff]+))|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\u0000-\uffff~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\u0000-\uffff~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\u0000-\uffff~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\u0000-\uffff~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\u0000-\uffff~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\u0000-\uffff~!$ |\/.,*:;=]|%[a-f\d]{2})*)?$/i;let o,t,n=PlayGMChatDiscord.ROOM("Discord"),i=firebase.database().ref("connections"),a=firebase.storage().ref("icons-discord"),d=firebase.storage().ref("uploads"),r={},s=STORE("PlayGMChat"),l=s.get("skin");void 0===l&&(l="기본");let c=SKINS[l];void 0===c&&(c=SKINS.기본);let f=()=>{void 0!==global.Notification&&"granted"!==Notification.permission&&Notification.requestPermission();let l;A({style:{position:"fixed",right:"Android"!==INFO.getOSName()&&"iOS"!==INFO.getOSName()?18:0,top:0,padding:10,zIndex:998,color:c.color},c:FontAwesome.GetIcon("bars"),on:{tap:()=>{void 0!==l&&l.remove(),l=UUI.PANEL({style:{position:"fixed",right:0,top:0,width:260,height:"100%",backgroundColor:"#444",color:"#fff",overflowY:"scroll",zIndex:999},contentStyle:{padding:20},c:[A({style:{position:"fixed",right:"Android"!==INFO.getOSName()&&"iOS"!==INFO.getOSName()?18:0,top:0,padding:10},c:FontAwesome.GetIcon("times"),on:{tap:()=>{l.remove(),l=void 0}}}),H3({style:{fontSize:30,fontWeight:"bold"},c:"MENU"}),A({style:{marginTop:10,display:"block",padding:10,border:"1px solid #fff",borderRadius:5},c:UUI.BUTTON_H({style:{margin:"auto"},icon:FontAwesome.GetIcon({style:{marginTop:2},key:"info-circle"}),spacing:10,title:"명령어"}),on:{mouseover:(e,o)=>{o.addStyle({backgroundColor:"#fff",color:"#000"})},mouseout:(e,o)=>{o.addStyle({backgroundColor:"transparent",color:"#fff"})},tap:()=>{b()}}}),A({style:{marginTop:10,display:"block",padding:10,border:"1px solid #fff",borderRadius:5},target:"_blank",href:"http://code.playgm.co.kr",c:UUI.BUTTON_H({style:{margin:"auto"},icon:FontAwesome.GetIcon({style:{marginTop:2},key:"code"}),spacing:10,title:"코드 프금"}),on:{mouseover:(e,o)=>{o.addStyle({backgroundColor:"#fff",color:"#000"})},mouseout:(e,o)=>{o.addStyle({backgroundColor:"transparent",color:"#fff"})}}}),A({style:{marginTop:10,display:"block",padding:10,border:"1px solid #fff",borderRadius:5},target:"_blank",href:"https://cafe.naver.com/playgm",c:UUI.BUTTON_H({style:{margin:"auto"},icon:FontAwesome.GetIcon({style:{marginTop:2},key:"coffee"}),spacing:10,title:"PlayGM 카페"}),on:{mouseover:(e,o)=>{o.addStyle({backgroundColor:"#fff",color:"#000"})},mouseout:(e,o)=>{o.addStyle({backgroundColor:"transparent",color:"#fff"})}}}),A({style:{marginTop:10,display:"block",padding:10,border:"1px solid #fff",borderRadius:5},target:"_blank",href:"https://github.com/Hanul/playgm-chat-firebase",c:UUI.BUTTON_H({style:{margin:"auto"},icon:FontAwesome.GetBrandIcon({style:{marginTop:1,width:14},key:"github"}),spacing:10,title:"소스코드"}),on:{mouseover:(e,o)=>{o.addStyle({backgroundColor:"#fff",color:"#000"})},mouseout:(e,o)=>{o.addStyle({backgroundColor:"transparent",color:"#fff"})}}}),A({style:{marginTop:10,display:"block",padding:10,border:"1px solid #fff",borderRadius:5},target:"_blank",href:"https://discordapp.com/channels/483554399243730959",c:UUI.BUTTON_H({style:{margin:"auto"},icon:FontAwesome.GetBrandIcon({style:{marginTop:1,width:14},key:"discord"}),spacing:10,title:"PlayGM 디스코드"}),on:{mouseover:(e,o)=>{o.addStyle({backgroundColor:"#fff",color:"#000"})},mouseout:(e,o)=>{o.addStyle({backgroundColor:"transparent",color:"#fff"})}}})]}).appendTo(BODY)}}}).appendTo(BODY);let f,u=[],p={},g=IMG({style:{position:"fixed",left:5,bottom:40},src:PlayGMChatDiscord.R("loading.gif")}).appendTo(BODY);BODY.addStyle({overflowY:"hidden"});let m=DIV({style:{backgroundColor:c.backgroundColor,color:c.color,paddingTop:10,overflowY:"scroll",onDisplayResize:(e,o)=>{return e<800?{fontSize:14,height:o-50}:{fontSize:"inherit",height:o-50}}},on:{tap:()=>{void 0!==l&&(l.remove(),l=void 0)}}}).appendTo(BODY),h=(DIV({style:{backgroundColor:c.backgroundColor,height:10}}).appendTo(BODY),()=>{m.scrollTo({top:999999})}),y=(e,o)=>{m.append(DIV({style:{color:c.systemColor,fontWeight:"bold",onDisplayResize:(e,o)=>{return e<800?{padding:"0 6px",paddingBottom:6}:{padding:"0 8px",paddingBottom:8}}},c:e})),o!==!1&&h()},b=()=>{y("명령어 : /명령어, /닉네임, /접속자, /스킨, /이모티콘, /프금, /로그아웃")},N=e=>{i.once("value",e=>{let o=[];e.forEach(e=>{o.push(e.val())});let t=0;o.forEach(e=>{e.time>t&&(t=e.time)});let n="",i=[];o.forEach(e=>{t-e.time<12e4&&(i.push(e),""!==n&&(n+=", "),n+=e.name)}),y("최근 유저("+i.length+"명) : "+n)})},I=e=>{let i=d.child(e.name).put(e);i.on("state_changed",e=>{C.empty(),C.append(INTEGER(e.bytesTransferred/e.totalBytes*100))},()=>{C.empty(),C.append(FontAwesome.GetIcon("upload"))},()=>{C.empty(),C.append(FontAwesome.GetIcon("upload")),i.snapshot.ref.getDownloadURL().then(i=>{n.send({methodName:"sendFile",data:{userId:o.uid,name:o.displayName,userIconURL:t,fileName:e.name,downloadURL:i}})})})},O=t=>{g.remove();let n=m.getScrollTop()>=m.getScrollHeight()-m.getHeight()-10;if("485064204144082948"===t.userId&&(t.name=t.message.substring(0,t.message.indexOf(":")-1),t.message=t.message.substring(t.message.indexOf(":")+2)),u.push(t),t.isNewCafeArticle===!0||"true"===t.isNewCafeArticle)y(["카페 새 글! ",A({style:{textDecoration:"underline"},target:"_blank",href:"http://cafe.naver.com/playgm/"+t.articleId,c:t.title+", by "+t.nickname})],!1);else if(t.isNewUGZArticle===!0||"true"===t.isNewUGZArticle)y(["새 유게짱! ",A({style:{textDecoration:"underline"},target:"_blank",href:t.link,c:t.title+", by 굿군"})],!1);else if(t.isNameChanged===!0)y("닉네임 변경 : "+t.originName+" -> "+t.newName);else{let i;m.append(DIV({style:{onDisplayResize:(e,o)=>{return e<800?{padding:"0 6px",paddingBottom:6}:{padding:"0 8px",paddingBottom:8}}},c:[i=IMG({style:{marginRight:5,onDisplayResize:(e,o)=>{return e<800?{marginBottom:-4,width:18,height:18,borderRadius:18}:{marginBottom:-5,width:20,height:20,borderRadius:20}}},src:"485064204144082948"!==t.userId||void 0===r[t.name]?void 0===t.userIconURL||"485064204144082948"===t.userId?PlayGMChatDiscord.R("default-icon.png"):t.userIconURL:r[t.name]}),SPAN({style:{fontWeight:"bolder",marginRight:6,color:c.nameColor},c:t.name}),SPAN({style:{fontSize:0},c:" : "}),void 0!==t.downloadURL?A({style:{fontWeight:"bolder",textDecoration:"underline"},c:void 0!==t.fileName?t.fileName:t.downloadURL,target:"_blank",href:t.downloadURL,on:{mouseover:e=>{"Android"===INFO.getOSName()||"iOS"===INFO.getOSName()||void 0!==f||t.fileName.indexOf(".png")===-1&&t.fileName.indexOf(".jpg")===-1&&t.fileName.indexOf(".jpeg")===-1&&t.fileName.indexOf(".gif")===-1||(f=UUI.V_CENTER({style:{position:"fixed",left:e.getLeft()+10,top:e.getTop()-42-8,width:90,height:60,backgroundColor:"#fff",backgroundImage:t.downloadURL,backgroundSize:"cover",backgroundPosition:"center center",border:"1px solid #333",textAlign:"center"},c:IMG({style:{marginTop:5},src:PlayGMChatDiscord.R("loading.gif")})}).appendTo(BODY),IMG({src:t.downloadURL,on:{load:()=>{f.empty()}}}))},mouseout:()=>{void 0!==f&&(f.remove(),f=void 0)}}}):RUN(()=>{let i=t.message;if(t.isCalled!==!0&&t.name!==o.displayName&&(i+" ").indexOf("@"+o.displayName+" ")!==-1){void 0===global.Notification||"granted"!==Notification.permission?DELAY(()=>{}):document.hasFocus()!==!0&&(new Notification(t.name,{body:i}).onclick=(()=>{focus()}));let e={};t.isCalled=!0,e[snapshot.key]=t}let a=[];return EACH(i.split(" "),(i,d)=>{d>0&&a.push(" ");let r=e=>{let i=e.match(/:[^:]*:/);if(i===TO_DELETE)a.push(e);else{let d=i[0],s=d.substring(1,d.length-1).toLowerCase();if(CHECK_IS_IN({array:EMOTICONS,value:s})===!0){let i=e.indexOf(d);a.push(e.substring(0,i)),a.push(IMG({style:{marginBottom:-4},src:PlayGMChatDiscord.R("emoticon/"+s+".png"),on:{load:()=>{n!==!0&&t.userId!==o.uid||h()}}})),e=r(e.substring(i+d.length))}else a.push(e)}return e},s=()=>{let o=i.match(e);if(o===TO_DELETE)i=r(i);else{let e=o[0];e.indexOf(" ")!==-1&&(e=e.substring(0,e.indexOf(" ")));let t=i.indexOf(e);i=r(i.substring(0,t)),i=i.substring(t+e.length),0!==e.indexOf("http://")&&0!==e.indexOf("https://")&&0!==e.indexOf("ftp://")&&(e="http://"+e),a.push(A({style:{textDecoration:"underline"},target:"_blank",href:e,c:e})),s()}};s()}),SPAN({c:a})})]})),"485064204144082948"===t.userId&&(void 0===p[t.name]&&(p[t.name]=[]),p[t.name].push(i),a.child(t.name).getDownloadURL().then(e=>{r[t.name]=e,EACH(p[t.name],o=>{o.setSrc(e)})}).catch(()=>{}))}n!==!0&&t.userId!==o.uid||h()};n.send("messages",e=>{REVERSE_EACH(e,O)}),n.on("message",O),EVENT("resize",()=>{DELAY(()=>{h()})});let S,T,v,C;FORM({style:{position:"fixed",bottom:0,width:"100%",boxShadow:"0 0 0.4em rgba(0, 0, 0, 0.15)"},c:[S=UUI.FULL_INPUT({style:{backgroundColor:c.backgroundColor,padding:10},inputStyle:{color:c.color},name:"message",placeholder:"메시지를 입력하세요.",isOffAutocomplete:!0,on:{tap:()=>{void 0!==l&&(l.remove(),l=void 0)},keydown:e=>{"Escape"===e.getKey()&&void 0!==T&&T.remove()},doubletap:()=>{void 0!==T&&T.remove(),T=DIV({style:{position:"fixed",left:5,bottom:43},c:[A({style:{flt:"left",padding:"4px 8px",border:"1px solid #999",backgroundColor:"#eee",borderRadius:3},c:"접속자",on:{tap:()=>{N()}}}),CLEAR_BOTH()]}).appendTo(BODY),EVENT_ONCE("tap",()=>{void 0!==T&&(T.remove(),T=void 0)})}}}),A({style:{position:"fixed",right:50,bottom:0,padding:8,color:"#ccc",fontSize:16},c:FontAwesome.GetIcon("cog"),on:{mouseover:(e,o)=>{o.addStyle({color:"#999"})},mouseout:(e,o)=>{o.addStyle({color:"#ccc"})},tap:()=>{let e,t,n,i=UUI.V_CENTER({style:{position:"fixed",left:0,top:0,width:"100%",height:"100%",backgroundColor:"rgba(255, 255, 255, 0.75)"},c:[UUI.V_CENTER({style:{position:"relative",backgroundColor:"#fff",width:240,height:150,borderRadius:20,boxShadow:"0 0 2em rgba(0, 0, 0, 0.2)",margin:"auto",textAlign:"center"},c:[H3({style:{position:"absolute",left:20,top:20,fontWeight:"bolder"},c:"아이콘"}),e=INPUT({style:{position:"fixed",left:-999999,top:-999999},type:"file",on:{change:()=>{let i=e.getEl().files[0];void 0!==i.size&&i.size<=4096?(n.empty(),n.append("업로드 중..."),a.child(o.displayName).put(i).then(e=>{a.child(o.displayName).getDownloadURL().then(e=>{t.setSrc(e),n.empty(),n.append("PNG, 4KB 이하")})})):alert("파일 용량이 초과하였습니다.")}}}),A({c:t=IMG({style:{width:20,height:20,borderRadius:20},src:void 0===r[o.displayName]?PlayGMChatDiscord.R("default-icon.png"):r[o.displayName]}),on:{tap:()=>{e.select()}}}),n=P({style:{marginTop:5},c:"PNG, 4KB 이하"}),A({style:{position:"absolute",right:20,bottom:20,fontWeight:"bolder",textDecoration:"underline"},c:"닫기",on:{tap:()=>{i.remove()}}})]})]}).appendTo(BODY)}}}),v=INPUT({style:{position:"fixed",left:-999999,top:-999999},type:"file",on:{change:()=>{let e=v.getEl().files[0];void 0!==e.size&&e.size<=20971520?I(e):alert("제한 크기를 초과한 파일입니다.")}}}),C=A({style:{position:"fixed",right:10,bottom:0,padding:8,color:"#ccc",fontSize:16},c:FontAwesome.GetIcon("upload"),on:{mouseover:(e,o)=>{o.addStyle({color:"#999"})},mouseout:(e,o)=>{o.addStyle({color:"#ccc"})},tap:()=>{v.select()}}})],on:{submit:(e,i)=>{let a=i.getData().message;if(i.setData({}),""!==a)if("/"===a[0]){let e=a.substring(1).split(" "),t=e[0];if(e.shift(),"닉네임"===t){let t=o.displayName;0===e.length?y("사용법 : /닉네임 [name]"):t!==e[0]&&/^[ㄱ-ㅎ가-힣a-zA-Z0-9]{1,6}$/.test(e[0])===!0&&o.updateProfile({displayName:e[0]}).then(()=>{})}else if("접속자"===t)N();else if("스킨"===t)if(0===e.length){let e="";EACH(SKINS,(o,t)=>{""!==e&&(e+=", "),e+=t}),y("사용법 : /스킨 [skin], 스킨 종류 : "+e)}else void 0!==SKINS[e[0]]&&(s.save({name:"skin",value:e[0]}),location.reload());else if("이모티콘"===t){let e="";EACH(EMOTICONS,(o,t)=>{t>0&&(e+=", "),e+=o}),y("이모티콘 사용법 : 메시지 중간에 :이모티콘:과 같은 형태로 사용, 이모티콘 종류 : "+e)}else"로그아웃"===t?firebase.auth().signOut():"프금"===t?open("https://cafe.naver.com/playgm"):b()}else n.send({methodName:"send",data:{userId:o.uid,name:o.displayName,userIconURL:t,message:a.trim()}})}}}).appendTo(BODY),S.focus(),INTERVAL(60,RAR(()=>{i.child(o.uid).set({name:o.displayName,time:firebase.database.ServerValue.TIMESTAMP})})),N(!0),EVENT("paste",e=>{EACH(e.getClipboardItems(),o=>{if(o.type.indexOf("image")!==-1){let t=o.getAsFile();return void 0!==t.size&&t.size<=20971520?confirm("클립보드의 이미지를 업로드 하시겠습니까?")===!0&&I(t):alert("제한 크기를 초과한 파일입니다."),e.stopDefault(),!1}})}),"Android"!==INFO.getOSName()&&"iOS"!==INFO.getOSName()&&(EVENT("dragover",e=>{e.stop()}),EVENT("mousemove",e=>{void 0!==f&&f.addStyle({left:e.getLeft()+10,top:e.getTop()-f.getHeight()-8})}),EVENT("drop",e=>{EACH(e.getFiles(),I),e.stopDefault()})),a.child(o.displayName).getDownloadURL().then(e=>{t=e,r[o.displayName]=e,EACH(p[o.displayName],o=>{o.setSrc(e)})}).catch(()=>{})};firebase.auth().onAuthStateChanged(e=>{if(e===TO_DELETE){let e=DIV({style:{marginTop:20}}).appendTo(BODY);new firebaseui.auth.AuthUI(firebase.auth()).start(e.getEl(),{signInOptions:[firebase.auth.EmailAuthProvider.PROVIDER_ID],callbacks:{signInSuccessWithAuthResult:t=>{return e.remove(),void 0===o&&(o=t.user,f()),!1}}})}else void 0===o&&(o=e,f())})}}),global.SKINS={"기본":{backgroundColor:"#fff",color:"#444",nameColor:"#444",systemColor:"#080"},"다크":{backgroundColor:"#252526",color:"#dcdcdc",nameColor:"#569cd6",systemColor:"#090"},"디코":{backgroundColor:"rgb(54, 57, 64)",color:"rgb(195, 196, 198)",nameColor:"#fff",systemColor:"rgb(114, 137, 218)"}};